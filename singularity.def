Bootstrap: docker
From: continuumio/miniconda3:latest

%environment
    export PATH=/opt/conda/envs/snakemake/bin:$PATH

%files
    resources/PhyloFisherDatabase_v1.0 /
    resources/mb_downloads /
    resources/busco_downloads /
%post
    set -e
    echo "Setting portable compiler flags + micromamba ..."

    apt-get update && apt-get install -y build-essential git wget curl libtiff6 libgl1 libxext6 libsm6 libxrender1 \
        && rm -rf /var/lib/apt/lists/*

    curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba

    export PATH=$PWD/bin:$PATH
    export MAMBA_ROOT_PREFIX=/opt/micromamba
    export MAMBA_EXE=$PWD/bin/micromamba
    mkdir -p /opt/micromamba/bin
    ln -s $MAMBA_EXE /opt/micromamba/bin/mamba # micromamba masked as mamba via symlink, because snakemake now ignores frontend flags
    export CONDA_SUBDIR=linux-64
    # built using newer architecture, so we need to set these older environmentals so people other than me can use it
    export CFLAGS="-march=x86-64 -mtune=generic"
    export CXXFLAGS="-march=x86-64 -mtune=generic"
    export CPPFLAGS="$CFLAGS"
    export LDFLAGS=""
    export GOAMD64=v1
   

    apt-get install -y libtiff6 && ln -s /usr/lib/x86_64-linux-gnu/libtiff.so.6 /usr/lib/x86_64-linux-gnu/libtiff.so.5

    . /opt/conda/etc/profile.d/conda.sh # had to learn a crumb of POSIX shell magic to make this work

    git clone https://github.com/JD-X1/compact_classification.git
    cd compact_classification
    git checkout EPDB-test 

    micromamba create -y -p /opt/conda/envs/compleasm -f /compact_classification/envs/compleasm.yaml
    micromamba create -y -p /opt/conda/envs/snakemake -f /compact_classification/envs/snakemake.yaml
    micromamba create -y -p /opt/conda/envs/fisher -f /compact_classification/envs/fisher.yaml
    micromamba create -y -p /opt/conda/envs/pline_max -f /compact_classification/envs/pline_max.yaml
    micromamba create -y -p /opt/conda/envs/pythas_two -f /compact_classification/envs/pythas_two.yaml
    micromamba create -y -p /opt/conda/envs/raxml-ng -f /compact_classification/envs/raxml-ng.yaml
    micromamba create -y -p /opt/conda/envs/trimal -f /compact_classification/envs/trimal.yaml
    micromamba create -y -p /opt/conda/envs/div -f /compact_classification/envs/div.yaml
    micromamba create -y -p /opt/conda/envs/dendropy -f /compact_classification/envs/dendropy.yaml
    micromamba create -y -p /opt/conda/envs/gappa -f /compact_classification/envs/gappa.yaml
    micromamba create -y -p /opt/conda/envs/busco -f /compact_classification/envs/busco.yaml


    #wget https://ndownloader.figshare.com/files/29093409 
    #tar -xzvf 29093409 
    mv /PhyloFisherDatabase_v1.0 /compact_classification/resources/. 
    #rm /compact_classification/29093409

    #/opt/conda/envs/compleasm/bin/compleasm download eukaryota
    mv /mb_downloads /compact_classification/resources/.

    #/opt/conda/envs/busco/bin/busco --download eukaryota_odb12 -L
    mv /busco_downloads/ /compact_classification/resources/

    cd ..
    echo "export PATH=/opt/micromamba/envs/snakemake/bin:\$PATH" >> ~/.bashrc
    export PATH=/opt/micromamba/bin:$PATH # should, arguably, enforce fake symlink from here on

%runscript
    #!/bin/bash
    set -euo pipefail

    export PATH=/opt/micromamba/bin:$PATH
    export PATH=/opt/conda/envs/snakemake/bin:$PATH

    # defaults
    CORES=2
    MAG_DIR="input"
    MODE="concat"      # concat | sgt
    OUTDIR_ARG="output"
    DATABASE="PF"
    AUGUSTUS=false
    TRIM=false
    PURGE=""

    # flags-first; fallback to positional for back-compat
    if [[ $# -gt 0 && "$1" == -* ]]; then
    while [[ $# -gt 0 ]]; do
        case "$1" in
        -c|--cores)   CORES="$2"; shift 2;;
        -m|--mag-dir) MAG_DIR="$2"; shift 2;;
        -M|--mode)    MODE="$2"; shift 2;;
        -o|--outdir)  OUTDIR_ARG="$2"; shift 2;;
        -d|--db)      DATABASE="$2"; shift 2;;
        -a|--augustus) AUGUSTUS=true; shift 1;;
        -t|--trim)     TRIM=true; shift 1;;
        -p|--purge)    PURGE="${2:-}"; shift 2;;
        -h|--help)
            cat <<EOF
    Usage:
    singularity run image.sif [options]

    Options:
    -c, --cores N
    -m, --mag-dir PATH
    -M, --mode concat|sgt
    -o, --outdir PATH
    -d, --db PF|...
    -a, --augustus        enable BUSCO+Augustus
    -t, --trim            enable trimming
    -p, --purge VALUE     purge by Unique ID or Long Name
EOF
            exit 0;;
        *) echo "Unknown option: $1" >&2; exit 2;;
        esac
    done
    else
    # positional: 1=cores 2=mag_dir 3=mode 4=outdir 5=db 6=augustus 7=trim 8=purge
    CORES="${1:-$CORES}"
    MAG_DIR="${2:-$MAG_DIR}"
    MODE="${3:-$MODE}"
    OUTDIR_ARG="${4:-$OUTDIR_ARG}"
    DATABASE="${5:-$DATABASE}"
    AUGUSTUS=false; [[ "${6:-}" == "augustus" ]] && AUGUSTUS=true
    TRIM=false;     [[ "${7:-}" =~ ^(trim|true|1)$ ]] && TRIM=true
    PURGE="${8:-}"
    fi

    # normalize outdir to absolute with one trailing slash
    ABS_OUTDIR="$(python -c 'import os,sys; print(os.path.abspath(sys.argv[1]).rstrip(os.sep) + os.sep)' \
        "${OUTDIR_ARG}")"
    
    mkdir -p "${ABS_OUTDIR}"

    # pick ruleset
    if [[ "${MODE}" == "concat" ]]; then
    RULESET="/compact_classification/rules/taxa_class_${DATABASE}_concat.smk"
    elif [[ "${MODE}" == "sgt" ]]; then
    RULESET="/compact_classification/rules/taxa_class_${DATABASE}.smk"
    else
    echo "Unknown MODE='${MODE}'. Use concat or sgt." >&2; exit 2
    fi

    # build --config (each toggle independent)
    CFG=( "mag_dir=${MAG_DIR}" "mode=${MODE}" "outdir=${ABS_OUTDIR}" )
    $AUGUSTUS && CFG+=( "augustus=True" )
    $TRIM     && CFG+=( "trim=True" )
    [[ -n "${PURGE}" ]] && CFG+=( "purge=${PURGE@Q}" )

    exec snakemake -s "${RULESET}" \
    --cores "${CORES}" \
    --config "${CFG[@]}" \
    --use-conda --conda-frontend mamba \
    -p --keep-going --rerun-incomplete

