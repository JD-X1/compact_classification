Bootstrap: docker
From: continuumio/miniconda3

%environment
    export PATH=/opt/conda/envs/snakemake/bin:$PATH

%post
    apt-get update && apt-get install -y git wget curl libtiff6 libgl1 libxext6 libsm6 libxrender1 \
        && rm -rd /var/lib/apt/lists/*
    
    apt-get update && apt-get install -y libtiff6 && ln -s /usr/lib/x86_64-linux-gnu/libtiff.so.6 /usr/lib/x86_64-linux-gnu/libtiff.so.5

    
    conda install -n base -c conda-forge mamba

    git clone https://github.com/JD-X1/compact_classification.git
    cd compact_classification

    # Create the conda environment
    mamba env create -p /opt/conda/envs/snakemake -f envs/snakemake.yaml
    mamba env create -p /opt/conda/envs/pline_max -f envs/pline_max.yaml
    mamba env create -p /opt/conda/envs/fisher -f envs/fisher.yaml
    mamba env create -p /opt/conda/envs/mb -f envs/mb.yaml
    mamba env create -p /opt/conda/envs/compleasm -f envs/compleasm.yaml
    mamba env create -p /opt/conda/envs/div -f envs/div.yaml
    mamba env create -p /opt/conda/envs/trimal -f envs/trimal.yaml
    mamba env create -p /opt/conda/envs/pythas_two -f envs/pythas_two.yaml
    mamba env create -p /opt/conda/envs/dendropy -f envs/dendropy.yaml

    conda activate compleasm \
        && compleasm download eukaryota \
        && mv mb_downloads resources/

    wget https://ndownloader.figshare.com/files/29093409 \
        && tar -xzvf 29093409 \
        && cp -r PhyloFisherDatabase_v1.0 resources/. \
        && rm 29093409 \
        && cd ..

    echo "conda activate snakemake" >> ~/.bashrc

%runscript
    exec snakemake -s rules/taxa_class_PF_concat.smk \
        --cores ${1:-1} \
        --config mag_dir=${2:-"."} mode=CONCAT \
        --use-conda -p --keep-going --rerun-incomplete
